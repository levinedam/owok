<!-- This file is part of NeuraSelf-UwU.
 Copyright (c) 2025-Present Routo

 NeuraSelf-UwU is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

You should have received a copy of the GNU General Public License
along with NeuraSelf-UwU. If not, see <https://www.gnu.org/licenses/>. -->




<!DOCTYPE html>
<html lang="en">


<!--
Sorry for this bad inline code bcz sometimes i don't want  to move my hands from keyboard to create a new file.

-->

<head>
    <meta charset="UTF-8">
    <title>Neura Self</title>
    <link rel="icon" type="image/x-icon" href="/static/assets/neura.ico">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Rajdhani:wght@400;600&family=Roboto+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* CAPTCHA ZOOM */
        .captcha-img-container {
            transition: transform 0.3s ease;
            cursor: zoom-in;
            display: inline-block;
        }

        .captcha-img-container:hover {
            transform: scale(1.5);
            z-index: 1000;
            position: relative;
        }

        .btn-captcha-submit:hover {
            background: #00d16e;
            transform: translateY(-2px);
        }

        /* KPI CARD HIGHLIGHT */
        .kpi-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(255, 31, 31, 0.2);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .kpi-data {
            transition: opacity 0.2s ease;
        }

        .kpi-data:hover {
            opacity: 0.8;
        }
    </style>
</head>

<body>

    <!-- Mobile Menu Toggle Button -->
    <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <!-- Mobile Top Controls -->
    <div class="mobile-top-controls">
        <button class="mobile-control-btn gold" onclick="action('cash', this)" title="Check Cash">
            <i class="fa-solid fa-coins"></i>
        </button>
        <button class="mobile-control-btn green" onclick="action('start', this)" title="Start Bot">
            <i class="fa-solid fa-play"></i>
        </button>
        <button class="mobile-control-btn red" onclick="action('stop', this)" title="Stop Bot">
            <i class="fa-solid fa-stop"></i>
        </button>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleMobileMenu()"></div>

    <div class="app-shell" style="display:flex; height:100vh;">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="brand">
                <img src="/static/assets/neuralogo.png" alt="NeuraSelf" style="height: 32px; margin-right: 8px;">
                <span class="brand-main"
                    style="background:linear-gradient(90deg, #ff1f1f, #880000); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;">NEURA</span>
                <span class="brand-sub" style="color:#ff1f1f">SELF</span>
            </div>

            <nav class="nav-links">
                <a class="nav-item active" onclick="nav('dash', this)"><i class="fa-solid fa-chart-pie"></i>
                    Dashboard</a>
                <a class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> Configuration</a>
                <a class="nav-item" onclick="nav('security', this)"><i class="fa-solid fa-shield-halved"></i>
                    Security</a>

                <a class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-clock-rotate-left"></i>
                    History</a>
                <a class="nav-item" onclick="nav('logs', this)"><i class="fa-solid fa-terminal"></i> Terminal</a>
            </nav>

            <div style="margin-top:auto">
                <div class="status-indicator">
                    <div class="ping-dot" id="statusDot"></div>
                    <span id="botStatus">ONLINE</span>
                </div>
                <div class="social-links">
                    <a href="https://github.com/routo-loop" target="_blank"><i class="fa-brands fa-github social-btn"
                            title="GitHub"></i></a>
                    <a href="https://discord.gg/3gYUZHRjKC" target="_blank"><i class="fa-brands fa-discord social-btn"
                            title="Discord"></i></a>
                    <a href="https://www.youtube.com/@dev1-9?sub_confirmation=1" target="_blank"><i
                            class="fa-brands fa-youtube social-btn" title="YouTube"></i></a>
                </div>
                <div class="version">v2.0.0</div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="content-area">

            <!-- DASHBOARD -->
            <div id="dash" class="active-view view">
                <div class="top-bar">
                    <h1>System Overview</h1>
                    <div class="top-controls">
                        <button class="btn-control gold" onclick="action('cash', this)"><i
                                class="fa-solid fa-coins"></i>
                            CHECK CASH</button>
                        <button class="btn-control green" onclick="action('start', this)"><i
                                class="fa-solid fa-play"></i>
                            START</button>
                        <button class="btn-control red" onclick="action('stop', this)"><i class="fa-solid fa-stop"></i>
                            STOP</button>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-icon cash"><i class="fa-solid fa-coins"></i></div>
                        <div class="kpi-data" style="cursor:pointer" onclick="action('cash', this)">
                            <h3>Balance</h3>
                            <p id="cash">0</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon rate"><i class="fa-solid fa-clock"></i></div>
                        <div class="kpi-data">
                            <h3>Uptime</h3>
                            <p id="uptimeDisplay">00:00:00</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon cmds"><i class="fa-solid fa-gun"></i></div>
                        <div class="kpi-data">
                            <h3>Hunts Today</h3>
                            <p id="huntsToday">0</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon cmds"><i class="fa-brands fa-battle-net"></i></div>
                        <div class="kpi-data">
                            <h3>Battles Today</h3>
                            <p id="battlesToday">0</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon rate"><i class="fa-solid fa-bolt"></i></div>
                        <div class="kpi-data">
                            <h3>CPM</h3>
                            <p id="cpm">0</p>
                        </div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-icon cmds"><i class="fa-solid fa-ghost"></i></div>
                        <div class="kpi-data">
                            <h3>OwO Sent</h3>
                            <p id="totalOwO">0</p>
                        </div>
                    </div>
                </div>

                <div style="display:flex; gap:20px; height:350px;">
                    <div
                        style="flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px;">
                        <canvas id="distChart"></canvas>
                    </div>
                    <div
                        style="flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px;">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="config" class="view">
                <div class="top-bar">
                    <h1>Configuration</h1>
                    <div class="top-controls">
                        <button class="btn-control green" onclick="saveAllConfigs()">
                            <i class="fa-solid fa-floppy-disk"></i> SAVE SETTINGS
                        </button>
                    </div>
                </div>

                <div id="settings-grid" class="settings-grid-layout">
                    <!-- Configuration cards will be injected here dynamically -->
                </div>
            </div>

            <!-- SECURITY -->
            <div id="security" class="view">
                <div class="top-bar">
                    <h1>Security Center</h1>
                    <button class="btn-control green" onclick="resumeBot()"><i class="fa-solid fa-play"></i> RESUME
                        BOT</button>
                </div>

                <div id="securityAlert" class="alert-box" style="display:none; margin-bottom: 20px;">
                    <div class="alert-msg">
                        <i class="fa-solid fa-triangle-exclamation"></i> SECURITY TRIGGERED: BOT PAUSED
                    </div>
                    <div id="captchaMsg"
                        style="color:#aaa; font-family:var(--font-mono); margin-bottom:20px; font-size:0.9rem; border:1px solid #333; padding:10px; border-radius:4px; max-width:80%; text-align:center;">
                        <!-- Last Captcha Message -->
                    </div>
                </div>

                <div class="security-stats">
                    <div class="sec-stat-box">
                        <div class="sec-val" id="sec-captchas">0</div>
                        <div class="sec-lbl">Solved</div>
                    </div>
                    <div class="sec-stat-box">
                        <div class="sec-val" id="sec-bans" style="color:var(--danger)">0</div>
                        <div class="sec-lbl">Bans</div>
                    </div>
                    <div class="sec-stat-box">
                        <div class="sec-val" id="sec-warns" style="color:var(--warning)">0</div>
                        <div class="sec-lbl">Warns</div>
                    </div>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="history" class="view">
                <div class="top-bar">
                    <h1>Detailed Analytics & History</h1>
                    <div class="top-controls">
                        <select id="session-select" class="session-select" onchange="renderSessionChart()">
                            <option value="all">ALL SESSIONS</option>
                        </select>
                        <button class="btn-control input-dark" onclick="loadHistory()"><i class="fa-solid fa-sync"></i>
                            REFRESH DATA</button>
                    </div>
                </div>

                <div class="analytics-grid"
                    style="display:grid; grid-template-columns: repeat(4, 1fr); gap:20px; padding:0 20px 20px 20px;">
                    <div class="kpi-card">
                        <div style="color:var(--text-muted); font-size:0.9em;">TOTAL SESSIONS</div>
                        <div id="total-sessions" style="font-size:2em; font-weight:bold; color:var(--primary);">0</div>
                    </div>
                    <div class="kpi-card">
                        <div style="color:var(--text-muted); font-size:0.9em;">ALL-TIME HUNTS</div>
                        <div id="total-hunts" style="font-size:2em; font-weight:bold; color:var(--success);">0</div>
                    </div>
                    <div class="kpi-card">
                        <div style="color:var(--text-muted); font-size:0.9em;">ALL-TIME BATTLES</div>
                        <div id="total-battles" style="font-size:2em; font-weight:bold; color:#3b82f6;">0</div>
                    </div>
                    <div class="kpi-card">
                        <div style="color:var(--text-muted); font-size:0.9em;">TOTAL COMMANDS</div>
                        <div id="total-cmds" style="font-size:2em; font-weight:bold; color:#fff;">0</div>
                    </div>
                </div>

                <div style="display:flex; gap:20px; height:300px; padding:0 20px 20px 20px;">
                    <div
                        style="flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px;">
                        <canvas id="sessionChart"></canvas>
                    </div>
                    <div
                        style="flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px;">
                        <canvas id="cashHistoryChart"></canvas>
                    </div>
                </div>

                <div style="padding:0 20px 10px 20px; display:flex; gap:10px;">
                    <button class="badge active" onclick="filterHistory('all', this)">ALL</button>
                    <button class="badge success" onclick="filterHistory('CMD', this)">COMMANDS</button>
                    <button class="badge info" onclick="filterHistory('SYS', this)">SYSTEM</button>
                    <button class="badge warning" onclick="filterHistory('SECURITY', this)">SECURITY</button>
                </div>

                <div class="history-container" style="height:400px; padding:20px;">
                    <div id="history-feed" class="terminal-history"></div>
                </div>
            </div>

            <!-- TERMINAL -->
            <div id="logs" class="view">
                <div class="top-bar">
                    <h1>System Terminal</h1>
                    <button class="btn-control" onclick="update()">
                        <i class="fa-solid fa-rotate"></i> RELOAD LOGS
                    </button>
                </div>
                <div id="term" class="terminal-window"></div>
            </div>
        </main>
    </div>

    <script>
        // --- STATE ---
        let currentConfig = {}, globalAnalyticsData = null;
        let distChart = null, lineChart = null, sessChart = null, cashChart = null;

        // --- NAVIGATION ---
        function nav(id, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active-view');
            el.classList.add('active');
            if (window.innerWidth <= 768) toggleMobileMenu();

            if (id === 'config') loadConfig();
            if (id === 'history') loadHistory();
        }

        function toggleMobileMenu() {
            const s = document.querySelector('.sidebar'), o = document.querySelector('.sidebar-overlay'), t = document.querySelector('.mobile-menu-toggle');
            s.classList.toggle('active'); o.classList.toggle('active'); t.classList.toggle('active');
            document.body.style.overflow = s.classList.contains('active') ? 'hidden' : '';
        }

        // --- CONFIG MANAGER ---
        async function loadConfig() {
            const r = await fetch('/api/settings');
            currentConfig = await r.json();
            renderSettings(currentConfig);
        }

        function renderSettings(cfg) {
            const grid = document.getElementById('settings-grid');
            grid.innerHTML = '';

            Object.keys(cfg).forEach(key => {
                if (key === 'commands') {
                    Object.keys(cfg[key]).forEach(cmd => {
                        grid.appendChild(createModuleCard(cmd.toUpperCase(), cfg[key][cmd], `commands.${cmd}`));
                    });
                } else if (typeof cfg[key] === 'object' && !Array.isArray(cfg[key])) {
                    grid.appendChild(createModuleCard(key.toUpperCase(), cfg[key], key));
                }
            });
        }

        function createModuleCard(title, data, path) {
            const card = document.createElement('div');
            card.className = 'module-card';
            card.innerHTML = `
                <div class="module-header" onclick="toggleDropdown(this)">
                    <span class="module-title">${title}</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="dropdown-content">
                    ${renderCategory(data, path)}
                </div>
            `;
            return card;
        }

        function renderCategory(obj, path) {
            let h = '';
            let keys = Object.keys(obj);
            const isTiers = path.includes('tiers');
            const isTypes = path.includes('types');

            // Enforce Tier order for gems
            if (isTiers) {
                const tierOrder = ['common', 'uncommon', 'rare', 'epic', 'mythical', 'legendary', 'fabled'];
                keys.sort((a, b) => tierOrder.indexOf(a) - tierOrder.indexOf(b));
            }

            if (isTiers || isTypes) h += '<div class="gem-tier-group">';

            keys.forEach(key => {
                const val = obj[key];
                const fullPath = `${path}.${key}`;

                if ((isTiers || isTypes) && typeof val === 'boolean') {
                    // Compact Glowing Item
                    h += `
                        <div class="gem-tier-item ${key}">
                            <span class="gem-label">${key}</span>
                            <div class="module-toggle ${val ? 'on' : 'off'}" onclick="toggleMod('${fullPath}', this, event)">
                                <i class="fa-solid ${val ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> ${val ? 'ON' : 'OFF'}
                            </div>
                        </div>
                    `;
                } else if (typeof val === 'boolean') {
                    h += renderField(fullPath, { l: key, type: 'toggle' }, val);
                } else if (Array.isArray(val) && val.length === 2 && typeof val[0] === 'number') {
                    h += renderField(fullPath, { l: key, type: 'range' }, val);
                } else if (typeof val === 'object' && val !== null && !Array.isArray(val)) {
                    h += `
                        <div class="module-header" onclick="toggleDropdown(this)" style="margin-top: 15px; border: none; padding: 10px 0;">
                            <span class="module-title" style="font-size: 0.85rem;">${key}</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-content active">
                            ${renderCategory(val, fullPath)}
                        </div>
                    `;
                } else {
                    h += renderField(fullPath, { l: key, type: key.includes('url') ? 'password' : 'text' }, val);
                }
            });

            if (isTiers || isTypes) h += '</div>';
            return h;
        }

        function renderField(path, f, v) {
            if (f.type === 'toggle') return `<div class="field-group"><label class="field-label">${f.l}</label><div class="module-toggle ${v ? 'on' : 'off'}" onclick="toggleMod('${path}', this, event)"><i class="fa-solid ${v ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> ${v ? 'ON' : 'OFF'}</div></div>`;
            if (f.type === 'range') return `<div class="field-row"><div class="field-group"><label class="field-label">Min</label><input type="number" class="field-input" value="${v[0]}" onclick="event.stopPropagation()" onchange="updateArrVal('${path}',0,this.value)"></div><div class="field-group"><label class="field-label">Max</label><input type="number" class="field-input" value="${v[1]}" onclick="event.stopPropagation()" onchange="updateArrVal('${path}',1,this.value)"></div></div>`;
            return `<div class="field-group"><label class="field-label">${f.l}</label><input type="${f.type === 'password' ? 'password' : 'text'}" class="field-input" value="${v}" onclick="event.stopPropagation()" onchange="updateDeepVal('${path}',this.value)"></div>`;
        }

        function toggleMod(p, el, ev) {
            if (ev) ev.stopPropagation();
            const v = !el.classList.contains('on');
            setDeep(currentConfig, p.split('.'), v);

            // Update UI locally without re-rendering
            el.className = `module-toggle ${v ? 'on' : 'off'}`;
            el.innerHTML = `<i class="fa-solid ${v ? 'fa-toggle-on' : 'fa-toggle-off'}"></i> ${v ? 'ON' : 'OFF'}`;
        }
        function updateDeepVal(p, v) { setDeep(currentConfig, p.split('.'), !isNaN(v) && v !== "" ? Number(v) : v); }
        function updateArrVal(p, i, v) { const a = getDeep(currentConfig, p.split('.')); if (a) a[i] = Number(v); }

        function saveAllConfigs() {
            fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentConfig) }).then(() => alert("Settings Saved!"));
        }

        // --- UTILS ---
        function setDeep(o, p, v) { if (p.length === 1) o[p[0]] = v; else { if (!o[p[0]]) o[p[0]] = {}; setDeep(o[p[0]], p.slice(1), v); } }
        function getDeep(o, p) { if (!o || p.length === 0) return o; return getDeep(o[p[0]], p.slice(1)); }

        // --- DASHBOARD CHARTS ---
        function initDashCharts() {
            try {
                const c1 = document.getElementById('distChart').getContext('2d');
                distChart = new Chart(c1, {
                    type: 'pie',
                    data: { labels: ['Hunt', 'Battle', 'Others'], datasets: [{ data: [1, 1, 1], backgroundColor: ['#ff1f1f', '#3b82f6', '#888'], borderWidth: 0 }] },
                    options: { plugins: { legend: { position: 'right' } } }
                });
                const c2 = document.getElementById('lineChart').getContext('2d');
                lineChart = new Chart(c2, {
                    type: 'line',
                    data: { labels: Array(30).fill(''), datasets: [{ data: Array(30).fill(0), borderColor: '#ff1f1f', backgroundColor: 'rgba(255,31,31,0.05)', fill: true, pointRadius: 2, pointHoverRadius: 5, tension: 0.3 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { x: { display: false }, y: { min: 0, suggestedMax: 10, grid: { color: '#222' }, ticks: { color: '#555', font: { size: 10 } } } },
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (e) { console.warn("Dashboard charts blocked"); }
        }

        // --- STATS LOOP ---
        function update() {
            fetch('/api/stats').then(r => r.json()).then(d => {
                if (d.cash) document.getElementById('cash').innerText = d.cash.toLocaleString();
                if (d.uptime) document.getElementById('uptimeDisplay').innerText = d.uptime;
                if (d.logs) renderLogs(d.logs);
                const dot = document.getElementById('statusDot'), lbl = document.getElementById('botStatus');
                lbl.innerText = d.status; dot.className = "ping-dot " + (d.status === "PAUSED" ? "paused" : "");
                if (d.status === "PAUSED" && d.security) {
                    document.getElementById('securityAlert').style.display = 'flex';
                    const msgEl = document.getElementById('captchaMsg');
                    if (msgEl) msgEl.innerText = d.security.last_message || "No details available";
                } else {
                    document.getElementById('securityAlert').style.display = 'none';
                }

                // Update Stats
                if (d.chart_data) {
                    document.getElementById('huntsToday').innerText = d.chart_data.hunt;
                    document.getElementById('battlesToday').innerText = d.chart_data.battle;
                    document.getElementById('cpm').innerText = d.chart_data.perf_bpm;
                    if (document.getElementById('totalOwO')) document.getElementById('totalOwO').innerText = d.chart_data.total;
                }

                // Update Dashboard Charts
                if (distChart && d.chart_data) {
                    distChart.data.datasets[0].data = [d.chart_data.hunt, d.chart_data.battle, d.chart_data.other];
                    distChart.update();
                }

                if (lineChart && d.chart_data) {
                    lineChart.data.datasets[0].data.push(d.chart_data.perf_bpm);
                    lineChart.data.datasets[0].data.shift();
                    lineChart.update('none');
                }
            });
        }
        setInterval(update, 2000);

        function renderLogs(logs) {
            const t = document.getElementById('term'); if (!t) return;
            t.innerHTML = logs.slice(-100).reverse().map(l => {
                const tagClass = l.type ? `tag-${l.type.toLowerCase()}` : '';
                return `<div class="history-item ${l.type ? l.type.toLowerCase() : ''}"><span class="history-time">[${l.time}]</span> <span class="history-tag ${tagClass}">${l.type}</span> <span class="history-msg">${l.message}</span></div>`;
            }).join('');
        }


        // --- DROPDOWN TOGGLE ---
        function toggleDropdown(element) {
            const parentCard = element.closest('.module-card');
            const dropdown = parentCard.querySelector('.dropdown-content');
            const icon = element.querySelector('i');

            dropdown.classList.toggle('active');
            element.classList.toggle('active');

            if (dropdown.classList.contains('active')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }


        function populateSessionDropdown() {
            const select = document.getElementById('session-select');
            const currentVal = select.value;
            select.innerHTML = '<option value="all">ALL SESSIONS</option>';
            if (!globalAnalyticsData || !globalAnalyticsData.sessions) return;
            [...globalAnalyticsData.sessions].reverse().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.innerText = `Session #${s.id}: ${s.date} ${s.start_time}`;
                select.appendChild(opt);
            });
            if (currentVal) select.value = currentVal;
        }

        function renderSessionChart() {
            const filterId = document.getElementById('session-select').value;
            if (!globalAnalyticsData) return;
            let filtered = filterId === 'all' ? globalAnalyticsData.sessions.slice(-20) : [globalAnalyticsData.sessions.find(x => String(x.id) === filterId)];
            const sctx = document.getElementById('sessionChart').getContext('2d');
            if (sessChart) sessChart.destroy();
            sessChart = new Chart(sctx, {
                type: 'bar',
                data: {
                    labels: filtered.map(s => `S${s.id}`),
                    datasets: [
                        { label: 'Hunts', data: filtered.map(s => s.stats.hunts), backgroundColor: '#ff1f1f' },
                        { label: 'Battles', data: filtered.map(s => s.stats.battles), backgroundColor: '#3b82f6' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false }, ticks: { color: '#666' } }, y: { grid: { color: '#222' }, ticks: { color: '#666' } } } }
            });
        }

        function renderCashChart() {
            if (!globalAnalyticsData) return;
            const cctx = document.getElementById('cashHistoryChart').getContext('2d');
            if (cashChart) cashChart.destroy();
            cashChart = new Chart(cctx, {
                type: 'line',
                data: {
                    labels: globalAnalyticsData.cash_history.map(c => c.timestamp.split(' ')[1]),
                    datasets: [{ label: 'Cash', data: globalAnalyticsData.cash_history.map(c => c.amount), borderColor: '#ffd700', backgroundColor: 'rgba(255, 215, 0, 0.1)', fill: true, tension: 0.3 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#666' } } } }
            });
        }

        let currentFilter = 'all';
        function filterHistory(type, el) {
            currentFilter = type;
            document.querySelectorAll('.badge').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            renderHistoryFeed();
        }

        function renderHistoryFeed() {
            const feed = document.getElementById('history-feed');
            if (!feed || !globalAnalyticsData || !globalAnalyticsData.recent_logs) return;
            feed.innerHTML = globalAnalyticsData.recent_logs
                .filter(l => {
                    if (currentFilter === 'all') return true;
                    if (currentFilter === 'SECURITY') return l.type === 'SECURITY' || l.type === 'ALARM';
                    return l.type === currentFilter;
                })
                .slice(-100).reverse().map(l => {
                    const tagClass = l.type ? `tag-${l.type.toLowerCase()}` : '';
                    return `<div class="history-item ${l.type ? l.type.toLowerCase() : ''}"><span class="history-time">[${l.time}]</span> <span class="history-tag ${tagClass}">${l.type}</span> <span class="history-msg">${l.message}</span></div>`;
                }).join('');
        }

        async function loadHistory() {
            try {
                const res = await fetch('/api/history/analytics');
                globalAnalyticsData = await res.json();
                const totals = globalAnalyticsData.totals || {};
                document.getElementById('total-sessions').innerText = totals.total_sessions || 0;
                document.getElementById('total-hunts').innerText = (totals.all_time_hunts || 0).toLocaleString();
                document.getElementById('total-battles').innerText = (totals.all_time_battles || 0).toLocaleString();
                document.getElementById('total-cmds').innerText = (totals.all_time_commands || 0).toLocaleString();
                populateSessionDropdown();
                renderCashChart();
                renderSessionChart();
                renderHistoryFeed();
            } catch (e) { console.error("History Error:", e); }
        }

        function resumeBot() { fetch('/api/security', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'resume' }) }).then(() => { document.getElementById('securityAlert').style.display = 'none'; update(); }); }
        function action(a, el) { fetch('/api/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: a }) }).then(() => update()); }

        document.addEventListener('DOMContentLoaded', () => { initDashCharts(); update(); loadConfig(); });
    </script>
</body>

</html>
